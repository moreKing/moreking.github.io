import{_ as a,c as i,ai as n,o as e}from"./chunks/framework.DcWFUpHS.js";const o=JSON.parse('{"title":"rsync","description":"","frontmatter":{},"headers":[],"relativePath":"ha/rsync.md","filePath":"ha/rsync.md","lastUpdated":1737611111000}'),l={name:"ha/rsync.md"};function t(p,s,r,h,d,k){return e(),i("div",null,s[0]||(s[0]=[n(`<h1 id="rsync" tabindex="-1">rsync <a class="header-anchor" href="#rsync" aria-label="Permalink to &quot;rsync&quot;">​</a></h1><p><code>rsync</code>是Linux系统下的数据镜像备份工具，使用快速增量备份工具Remote Sync可以远程同步，支持本地复制，或者与其他SSH、<code>rsync</code>主机同步。</p><p><code>rsync</code>英文称为remote synchronizetion，从软件的名称就可以看出来，<code>rsync</code>具有可使本地和远程两台主机之间的数据快速复制同步镜像、远程备份的功能，这个功能类似于<code>ssh</code>带的<code>scp</code>命令，但是又优于<code>scp</code>命令的功能，<code>scp</code>每次都是全量拷贝，而<code>rsync</code>可以增量拷贝。</p><p>它可以在本地计算机与远程计算机之间，或者两个本地目录之间同步文件（但不支持两台远程计算机之间的同步）。它也可以当作文件复制工具，替代<code>cp</code>和<code>mv</code>命令。但是同样也优于<code>cp</code>命令，<code>cp</code>每次都是全量拷贝，而<code>rsync</code>可以增量拷贝。</p><h3 id="_1-安装" tabindex="-1">1. 安装 <a class="header-anchor" href="#_1-安装" aria-label="Permalink to &quot;1. 安装&quot;">​</a></h3><div class="danger custom-block"><p class="custom-block-title">危险</p><p>远程复制文件时，必须在两台服务器同时安装 <code>rsync</code>才能正常进行同步</p></div><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-KBGs6" id="tab-TyAhm0k" checked><label data-title="Red Hat" for="tab-TyAhm0k">Red Hat</label><input type="radio" name="group-KBGs6" id="tab-h-24dEv"><label data-title="Debian/Ubuntu" for="tab-h-24dEv">Debian/Ubuntu</label><input type="radio" name="group-KBGs6" id="tab-bMwP8O0"><label data-title="Arch Linux" for="tab-bMwP8O0">Arch Linux</label><input type="radio" name="group-KBGs6" id="tab-uPpyLIY"><label data-title="二进制安装" for="tab-uPpyLIY">二进制安装</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pacman</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">进入下载页面</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://download.samba.org/pub/rsync/binaries/</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@more </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# tar xvf latest.tar.gz </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/man1/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/man1/rsync.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/man1/rsyncd.conf.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/man1/rsync-ssl.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/man/man5/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/doc/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/doc/README.md</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/doc/NEWS.md</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/share/doc/COPYING</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/bin/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/bin/rsync-ssl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">usr/local/bin/rsync</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@more </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# mv ./usr/local/bin/ /usr/local/rsync</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@more </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# ln -s /usr/local/rsync/rsync /usr/local/bin/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></div></div><h3 id="_2-基本用法" tabindex="-1">2. 基本用法 <a class="header-anchor" href="#_2-基本用法" aria-label="Permalink to &quot;2. 基本用法&quot;">​</a></h3><p>首先我们需要认识一下常用的参数以及格式</p><p><strong>格式</strong>：</p><ul><li><p>本地同步</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  SRC [SRC]...  DEST</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>上传/推送</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  SRC [SRC]...  [USER@]HOST:DEST</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  SRC [SRC]...  [USER@]HOST::DEST</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  SRC [SRC]...  rsync://[USER@]HOST[:PORT]/DEST</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>下载/拉取</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  [USER@]HOST:SRC [DEST]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  [USER@]HOST::SRC [DEST]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [OPTION]...  rsync://[USER@]HOST[:PORT]/SRC [DEST]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul><p>常用选项：</p><blockquote><p>注意，此处选项仅个人认为常用的选项，完整请使用 <code>rsync -h</code>命令查看</p></blockquote><table tabindex="0"><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>--verbose, -v</td><td>增加输出的详细程度</td></tr><tr><td>--stderr=e/a/c</td><td>更改标准错误输出模式（默认：错误）</td></tr><tr><td>--archive， -a</td><td>归档模式为-rlptgoD（不包括-A，-X，-U，-N，-H）</td></tr><tr><td>--recursive， -r</td><td>递归进入目录</td></tr><tr><td>--links， -l</td><td>复制符号链接作为符号链接</td></tr><tr><td>--perms， -p</td><td>保留权限</td></tr><tr><td>--group， -g</td><td>保留组</td></tr><tr><td>--owner， -o</td><td>保留所有者（超级用户）</td></tr><tr><td>--acls， -A</td><td>保留ACL（隐含--perms）</td></tr><tr><td>--update， -u</td><td>跳过接收端中更新的文件</td></tr><tr><td>-D</td><td>保存特殊文件、保存设备文件(仅限超级用户)</td></tr><tr><td>--times， -t</td><td>保存修改时间。</td></tr><tr><td>--crtimes， -N</td><td>保存创建时间（新鲜度）。</td></tr><tr><td>--delete</td><td>删除来自目标目录的多余文件</td></tr><tr><td>--compress， -z</td><td>在传输过程中压缩文件数据--compress-choice=STR 选择压缩算法（也称为--zc）</td></tr><tr><td>--compress-level=NUM</td><td>明确设置压缩级别（也称为--zl）</td></tr><tr><td>--backup, -b</td><td>创建备份（请参见--suffix 和 --backup-dir）</td></tr><tr><td>--backup-dir=DIR</td><td>在DIR目录下创建备份的层次结构</td></tr><tr><td>--suffix=SUFFIX</td><td>备份后缀名（默认值为不带--backup-dir的~）</td></tr><tr><td>--itemize-changes， -i</td><td>输出所有更新的变更摘要。</td></tr><tr><td>--progress</td><td>显示传输过程中的进度</td></tr><tr><td>-P</td><td>显示传输过程中的进度，保留部分传输的文件</td></tr><tr><td>--max-size=SIZE</td><td>传输忽略大于SIZE的文件：--max-size=&#39;100K&#39;</td></tr><tr><td>--min-size=SIZE</td><td>传输忽略小于SIZE的文件：--min-size=&#39;100K&#39;</td></tr><tr><td>--bwlimit=500</td><td>在同步过程中限制带宽使用率为 500 KB/s</td></tr><tr><td>--bwlimit=KBPS</td><td>限制带宽使用率，以 KB/s 为单位</td></tr></tbody></table><h3 id="_3-同步操作" tabindex="-1">3. 同步操作 <a class="header-anchor" href="#_3-同步操作" aria-label="Permalink to &quot;3. 同步操作&quot;">​</a></h3><h4 id="_3-1-模拟同步" tabindex="-1">3.1 模拟同步 <a class="header-anchor" href="#_3-1-模拟同步" aria-label="Permalink to &quot;3.1 模拟同步&quot;">​</a></h4><p>如果不确定 rsync 执行后会产生什么结果，可以先用<code>-n</code>或<code>--dry-run</code>参数模拟执行的结果。</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -anv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_3-2-保持相同" tabindex="-1">3.2 保持相同 <a class="header-anchor" href="#_3-2-保持相同" aria-label="Permalink to &quot;3.2 保持相同&quot;">​</a></h4><p>默认情况下，rsync 只确保源目录的所有内容（明确排除的文件除外）都复制到目标目录。它不会使两个目录保持相同，并且不会删除文件。如果要使得目标目录成为源目录的镜像副本，则必须使用<code>--delete</code>参数，这将删除只存在于目标目录、不存在于源目录的文件。</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_3-3-排除文件" tabindex="-1">3.3 排除文件 <a class="header-anchor" href="#_3-3-排除文件" aria-label="Permalink to &quot;3.3 排除文件&quot;">​</a></h4><ul><li><p><code>*.log</code>来排除所有以&quot;.log&quot;结尾的文件</p></li><li><p><code>temp*/</code>来排除以&quot;temp&quot;开头的目录。</p></li><li><p><code>dir1/*</code>排除目录内所有文件，目录本身不排除</p></li></ul><p>有时，我们希望同步时排除某些文件或目录，这时可以用<code>--exclude</code>参数指定排除模式。例如排除了所有 TXT 文件。</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;*.txt&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果要排除某个目录里面的所有文件，但不希望排除目录本身，可以写成下面这样。</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;dir1/*&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>多个排除模式，可以用多个<code>--exclude</code>参数</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;file1.txt&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;dir1/*&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>多个排除模式也可以利用 Bash 的大扩号的扩展功能，只用一个<code>--exclude</code>参数。</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;file1.txt&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;dir1/*&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果排除模式很多，可以将它们写入一个文件，每个模式一行，然后用<code>--exclude-from</code>参数指定这个文件。</p><p>创建<code>exclude-file.txt</code>文件，内容如下</p><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>tmp/</span></span>
<span class="line"><span>logs/</span></span>
<span class="line"><span>*.log</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -av</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --exclude-from=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;exclude-file.txt&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destination</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_4-免密传输" tabindex="-1">4. 免密传输 <a class="header-anchor" href="#_4-免密传输" aria-label="Permalink to &quot;4. 免密传输&quot;">​</a></h3><h4 id="_4-1-ssh免密" tabindex="-1">4.1 ssh免密： <a class="header-anchor" href="#_4-1-ssh免密" aria-label="Permalink to &quot;4.1  ssh免密：&quot;">​</a></h4><p>此处就不赘述了，标准的ssh免密登录即可</p><h4 id="_4-2-使用rsync服务方式进行同步免密" tabindex="-1">4.2 使用rsync服务方式进行同步免密 <a class="header-anchor" href="#_4-2-使用rsync服务方式进行同步免密" aria-label="Permalink to &quot;4.2  使用rsync服务方式进行同步免密&quot;">​</a></h4><p><code>rsyncd.conf</code>文件是作为 rsync 守护进程运行时的 rsync 配置文件,可控制身份验证、访问、日志记录和可用模块。</p><p>创建配置文件，例如：<code>/usr/local/rsync/config/rsyncd.conf</code>，配置详细说明请参考<a href="https://download.samba.org/pub/rsync/rsyncd.conf.5" target="_blank" rel="noreferrer">官方文档</a></p><div class="language-ini vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注释： #号开头的会被忽略</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 一行一个键值对，格式为：name=value 一行仅能写一个name=value</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 类似 ini 配置文件格式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 布尔值表示为 yes/no、0/1 或 true/false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此参数允许您指定要在每次连接时向客户端显示的“每日消息”（MOTD）。这通常包含网站信息和任何法律声明。默认值为无 MOTD 文件。在启动守护进程时， --dparam=motdfile=FILE 命令行选项可以覆盖此内容。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">motd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 指定守护程序进程ID文件，一般可以不配置，启动守护程序时， --dparam=pidfile=FILE 命令行选项可以覆盖文件名。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 您可以通过指定此值（默认为 873）来覆盖守护程序将侦听的默认端口。可被 --port 命令行选项取代。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 您可以通过指定此值来覆盖守护程序将侦听的默认 IP 地址。如果守护进程由 inetd 运行，则会忽略此值，并被 --address 命令行选项取代。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">gid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注意 上面是全局专属的部分变量，模块的变量也可以在全局定义，模块的名称不能为 [global]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 定义一个模块，名称随便起</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Module]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此参数指定一个描述字符串，当客户端获取可用模块的列表时，该字符串将显示在模块名称旁边</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">comment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此参数指定守护进程文件系统中要在此模块中可用的目录。您必须为每个模块指定此参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果 “use chroot” 为 true，则 rsync 守护进程将在开始与客户端进行文件传输之前 chroot 到“path”。这样做的优点是可以防止可能的实现安全漏洞，但它的缺点是需要超级用户权限，无法跟踪绝对或位于新根路径之外的符号链接，以及使按名称保存用户和组变得复杂</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">chroot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此参数允许您指定与连接客户端的主机名和 IP 地址匹配  空格分隔。如果所有模式都不匹配，则连接将被拒绝</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 逗号和空格分隔模式的列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hosts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">allow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =192.168.1.1 192.168.0/24 172.16.1.0/255.255.255.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此参数允许您指定与连接客户端的主机名和 IP 地址匹配  空格分隔。如果模式匹配，则连接将被拒绝</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hosts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">deny</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不存在的用户 自己定义，多个用户 空格分割</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可以在冒号 （:) 之后指定选项。这些选项允许您“拒绝”用户或组，将访问权限设置为“ro”（只读），或将访问权限设置为“rw”（读/写） deny：拒绝所有</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 您还可以通过“@”前缀指定组名匹配。使用组名匹配时，身份验证用户名必须是系统上的真实用户，否则将假定为任何组的成员</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">auth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = susan:ro joe:rw sam:deny</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 用户认证文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">secrets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>创建<code>/etc/systemd/system/rsync.service</code>文件</p><div class="language-ini vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=rsync service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">After</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WorkingDirectory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/rsync</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/rsync/rsync --daemon --no-detach --</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/rsync/config/rsyncd.conf</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Restart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=on-failure</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LimitNOFILE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=1048576</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=multi-user.target</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_5-实时同步文件inotify" tabindex="-1">5. 实时同步文件inotify <a class="header-anchor" href="#_5-实时同步文件inotify" aria-label="Permalink to &quot;5. 实时同步文件inotify&quot;">​</a></h3><p>安装<code>Inotify-tools</code></p><p>源码<a href="https://github.com/inotify-tools/inotify-tools/archive/refs/tags/4.23.9.0.tar.gz" target="_blank" rel="noreferrer">下载地址</a></p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-S8SF-" id="tab-2LNfZkA" checked><label data-title="Centos" for="tab-2LNfZkA">Centos</label><input type="radio" name="group-S8SF-" id="tab-6_1BfVT"><label data-title="Ubuntu" for="tab-6_1BfVT">Ubuntu</label><input type="radio" name="group-S8SF-" id="tab-KCS70nN"><label data-title="源码编译" for="tab-KCS70nN">源码编译</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  inotify-tools</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  inotify-tools</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autoconf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> automake</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libtool</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autotools-dev</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inotify-tools-xxxx.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inotify-tools-xxxx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./autogen.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./configure</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --prefix=/usr/local/inotify/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/inotify/bin/inotifywait</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/inotify/bin/inotifywatch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></div></div><p>用法: inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</p><p><code>-e|--event</code> :监听特定的事件。如果省略，则监听所有事件</p><p>Events :例如：<code>-e modify,create,delete,move</code></p><table tabindex="0"><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>access</td><td>访问文件或目录内容</td></tr><tr><td>modify</td><td>文件或目录内容被写入</td></tr><tr><td>attrib</td><td>文件或目录属性已更改</td></tr><tr><td>close_write</td><td>文件或目录在以可写模式打开后关闭</td></tr><tr><td>close_nowrite</td><td>文件或目录在以只读模式打开后关闭</td></tr><tr><td>close</td><td>文件或目录关闭，无论读/写模式</td></tr><tr><td>open</td><td>打开的文件或目录</td></tr><tr><td>moved_to</td><td>文件或目录移动到监视目录</td></tr><tr><td>moved_from</td><td>文件或目录从监视目录移动</td></tr><tr><td>move</td><td>文件或目录移动到监视目录或从监视目录移除</td></tr><tr><td>move_self</td><td>被监视的文件或目录被移动。</td></tr><tr><td>create</td><td>在被监视目录内创建的文件或目录</td></tr><tr><td>delete</td><td>文件或目录删除在监视目录</td></tr><tr><td>delete_self</td><td>删除文件或目录</td></tr><tr><td>unmount</td><td>文件系统包含文件或目录卸载</td></tr></tbody></table><p>一个简单的实时监控脚本</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> inotifywait</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> modify</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/messages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div>`,54)]))}const b=a(l,[["render",t]]);export{o as __pageData,b as default};
